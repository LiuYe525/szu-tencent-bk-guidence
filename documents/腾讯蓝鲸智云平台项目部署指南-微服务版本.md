### 项目部署指南-微服务版本

##### [github仓库地址：蓝鲸智云部署指南-微服务版本](https://github.com/LiuYe525/szu-tencent-bk-guidence/tree/cloud)

##### [github进不去可以去我的博客看(ps:手下留情别压测)](http://szuse.com.cn/)

##### 应用部署及增强服务激活过程详见([基础版部署指南](https://github.com/LiuYe525/szu-tencent-bk-guidence/blob/master/documents/%E8%85%BE%E8%AE%AF%E8%93%9D%E9%B2%B8%E6%99%BA%E4%BA%91%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md))

##### 此文档讲解如何配置微服务并且成功在蓝鲸平台上部署运行

---------------------------------

![image](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304191624837.png)

##### 第一部分

application.yml配置参数介绍：

spring.application.name:运行服务的名称，与后续nacos中注册的服务名称一致。

![image-20230424212155702](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242121990.png)

nacos下配置参数即nacos信息(请填写自己搭建的nacos信息**需要为公网ip**，若实在没有资源可寻求老师或作者的帮助)

NACOS_DISCOVERY/NACOS_CONFIG:nacos server的ip地址

SERVICE_IP:服务本身的ip地址(也可为域名比如后续在蓝鲸运行时)

SERVICE_PORT:服务的访问端口(请与服务本身的监听端口区别开来)

NACOS_PASSWORD:nacos server的访问密码(如果有的话)

如果不理解可以参考[nacos官方文档](https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html)

往下的DataSource、Redis、RabbitMQ配置与[基础版部署指南](https://github.com/LiuYe525/szu-tencent-bk-guidence/blob/master/documents/%E8%85%BE%E8%AE%AF%E8%93%9D%E9%B2%B8%E6%99%BA%E4%BA%91%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md)一致

bootstrap.yml配置参数介绍：

![image-20230424213317393](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242133205.png)

可以发现与application上部分配置一致，不再进行介绍

------------------

为本地服务器打包便捷引入了多环境配置文件 dev、prod

在application.yml中切换active为dev或prod即可使用不同的配置文件

------------------

部署重点：

在基础版部署过程的基础之上，需要设置环境变量，即需要将自己的nacos信息注入到容器当中

进入开发者中心->相应应用->应用编排->环境变量

![image-20230424213719770](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242137352.png)

此处与配置文件相对应

NACOS_DISCOVERY和NACOS_CONFIG为nacos server地址 格式应该为 ip:port(如127.0.0.1:8848)

SERVICE_IP为蓝鲸应用的ip此处用的apps.ce.bktencent.com(目的是让后面gateway正确路由以及feign正确寻址)地址在访问入口可见

![image-20230424213925719](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242139082.png)

NACOS_PASSWORD为nacos访问密码(如nacos)

SERVICE_PORT为服务访问ip(如果使用蓝鲸部署请务必填80，否则可能会导致无法访问)

变量填写完毕后点击发布发布到对应环境即可

-------------------

效果展示:

nacos中显示注册成功

![image-20230424214135069](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242141129.png)

使用gateway路由访问成功:

![image-20230424214239384](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242142092.png)

![image-20230424214252804](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242142925.png)

路由配置如下：(后续会详细讲解)

![image-20230424214309502](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242143494.png)

本地feign远程调用成功：

![image-20230424214457994](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242144032.png)

feign配置如下：

![image-20230424214527462](https://lye255-1316619619.cos.ap-guangzhou.myqcloud.com//markdown202304242145515.png)

此处未能解决使用name属性通过nacos调用失效的问题，故使用url和path的组合实现

##### ps: 本项目只保证在更新时间时讲解的步骤有效  

##### 更新时间:2023年4月24日21:46:52



#### 扩展SpringCloudGateway和Feign适配蓝鲸

#### 存在问题：

​	我们先来回顾一下蓝鲸智云对我们搭建微服务的作用，我们只需要将自己微服务打成一个docker镜像，在蓝鲸上跑起来，我们就可以公网访问到微服务。但是呢，我们访问服务的方式不是通过ip加端口，而是通过一段URL（如https://apps.ce.bktencent.com/bkguidance）,在这个基础上拼接自己接口对应的路径才可以访问到自己服务的接口（如https://apps.ce.bktencent.com/bkguidance/user/getMsg）。

​	我们知道，在微服务架构下，当请求到达网关，网关会根据路径匹配相应的服务id，随后到注册中心（nacos）上该服务id下成功注册的多个实例中通过负载均衡策略选出一个实例，在实例信息中找到该实例所部署的服务器的ip和端口，结合原来的请求转为一个新的请求再次发送（具体的情况自己去了解，我这里就不过多讲述）。但是，部署在蓝鲸的服务，通过ip和端口是访问不到的。

> 熟悉nginx的人一看到https://apps.ce.bktencent.com/bkguidance这一段就可以想到，蓝鲸的服务器上的nginx配置一个server监听443端口，host_name为apps.ce.bktencent.com，随后有一个location /bkguidance{...}，里面配置反向代理到真正可以以ip和端口访问你的服务的地址

​	同样的问题也出现在feign上面，feign中也是配置service-id，随后到注册中心找服务实例的ip和端口拼接访问。

#### 解决方案：

​	废话不多说，直接用debug的方式扒源码就知道了。

##### 网关：

​	随便用debug模式看一下Spring Cloud Gateway的执行流程，就可以很容易的发现Gateway中的一个全局过滤器ReactiveLoadBalancerClientFilter

![1686036104003](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036104003.png)

这上面的reconstructURI方法做的实际上就是去实例上找ip和端口拼接成新的uri，具体情况自己看。

知道了源码是这样之后，只需要在源码基础上进行小小的扩展即可。

扩展的思路很简单，就一个道理，部署在我的服务器的某个服务的实例可以通过ip和端口访问，而部署在蓝鲸的，则要根据蓝鲸提供的URL来访问，需要同时兼容这两种情况。

这个时候需要使用实例中的metadata。第一步，在项目的配置文件中配置metadata：

![1686036616018](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036616018.png)

metadata中有一个属性bkAccessUrl使用环境变量BK_ACCESS_URL的值，BK_ACCESS_URL这个环境变量，在将项目部署到蓝鲸启动之前需要填写为应用的访问地址，也就是将访问入口那串URL配置到应用编排的环境变量中。

![1686036790083](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036790083.png)

![1686036818423](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036818423.png)



编写一个新的ReactiveLoadBalancerClientFilter，重写reconstructURI方法，注入到IOC容器中：

![1686036886624](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036886624.png)



同时还需要配置这部分，替换掉原先的ReactiveLoadBalancerClientFilter

![1686036993032](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686036993032.png)



到这里就可以了。

经过如上的一番配置，注册到nacos中的所有服务实例，metadata中bkAccessUrl不为空的，说明部署在蓝鲸当中，使用bkAccessUrl来访问，而部署在自己的服务器中的实例，bkAccessUrl为空，使用原始的ip加端口的方式。



##### Feign

feign的跟网关的几乎一样，也是稍微用debug模式看一看源码的执行过程，就可以看到有一个类BlockingLoadBalancerClient（ps：使用LoadBalance作为Feign负载均衡实现，使用其他的实现可能是其他类，但是效果都差不多），里面同样有一个reconstructURI方法，同样的，编写一个新的类重写这个方法，重新注入到ioc容器中就可以了。

![1686037466125](E:\JAVA_Files\szu-tencent-bk-guidence\documents\assets\1686037466125.png)



完结撒花。

更新时间:2023年6月6日15:46